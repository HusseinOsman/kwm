#------------------------------------------------------------------------------#
printf "%s\n" "Rendering public key infrastructure."
#------------------------------------------------------------------------------#
mkdir -p $KWM_LOCAL_PKI_PATH
#------------------------------------------------------------------------------#
printf "%s\n" Generating cluster certificate authority.
#------------------------------------------------------------------------------#
$(basePath="$KWM_LOCAL_PKI_PATH" \
  name="cluster" \
  subj="/CN=$KWM_CLUSTER_NAME" render pki init-ca)
#------------------------------------------------------------------------------#
printf "%s\n" Generating private key for cluster admin to apiserver communication.
#------------------------------------------------------------------------------#
$(basePath="$KWM_LOCAL_PKI_PATH" \
  name="cluster-admin-to-apiserver" render pki private-key)
#------------------------------------------------------------------------------#
printf "%s\n" Generating cluster-ca signed certificate for cluster admin to apiserver communication.
#------------------------------------------------------------------------------#
$(basePath="$KWM_LOCAL_PKI_PATH" \
  name="cluster-admin-to-apiserver" \
  subj="/CN=root/O=system:masters" \
  ca="cluster" render pki signed-cert)
#------------------------------------------------------------------------------#
printf "%s\n" Generating etcd certificate authority.
#------------------------------------------------------------------------------#
$(basePath="$KWM_LOCAL_PKI_PATH" name="etcd" subj="/CN=etcd-ca" render pki init-ca)
#------------------------------------------------------------------------------#
printf "%s\n" Generating private key for apiserver to etcd server communication.
#------------------------------------------------------------------------------#
$(basePath="$KWM_LOCAL_PKI_PATH" name="apiserver-to-etcd" render pki private-key)
#------------------------------------------------------------------------------#
printf "%s\n" Generating etcd-ca signed certificate for apiserver to etcd communication.
#------------------------------------------------------------------------------#
$(basePath="$KWM_LOCAL_PKI_PATH" \
  name="apiserver-to-etcd" \
  subj="/CN=etcd" \
  ext="subjectAltName = $KWM_ETCD_CLIENT_SANS" \
  ca="etcd" render pki signed-cert)
#------------------------------------------------------------------------------#
printf "%s\n" Generating public/private keypair for service accounts
#------------------------------------------------------------------------------#
# TODO: get TLS bootstrapping going to eliminate some PKI creation
# https://kubernetes.io/docs/admin/bootstrap-tokens/
$(basePath="$KWM_LOCAL_PKI_PATH" name="service-account" render pki private-key)
$(basePath="$KWM_LOCAL_PKI_PATH" name="service-account" render pki public-key)
