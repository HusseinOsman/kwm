$(contents="Sending shared PKI to $name." partial log)
$(sourcePath="pki" \
  files="cluster-ca-cert.pem cluster-ca-private-key.pem etcd-ca-cert.pem etcd-ca-private-key.pem apiserver-to-etcd-cert.pem apiserver-to-etcd-private-key.pem service-account-private-key.pem service-account-public-key.pem" \
  partial tar-copy
)
$(contents="Installing $name." partial log)
$(contents="

$(contents="Generating private key for client to apiserver communication." partial log)
$(name="client-to-apiserver" partial private-key)
$(contents="Generating private key for apiserver to kubelet communication." partial log)
$(name="apiserver-to-kubelet" partial private-key)
$(contents="Generating cluster-ca signed certificate for client to apiserver communication." partial log)
$(ca="cluster" name="client-to-apiserver" subj="/CN=kube-apiserver" ext="subjectAltName = IP:$loadBalancerIp,IP:$kubernetesServiceIp,IP:$privateIp,DNS:$name,DNS:kubernetes,DNS:kubernetes.default,DNS:kubernetes.default.svc,DNS:kubernetes.default.svc.cluster,DNS:kubernetes.default.svc.cluster.local" caPath="$basePath" partial signed-cert)
$(contents="Generating cluster-ca signed certificate for apiserver to kubelet communication." partial log)
$(ca="cluster" name="apiserver-to-kubelet" subj="/CN=kube-apiserver-client/O=system:masters" ext="" caPath="$basePath" partial signed-cert)
$(contents="Ensuring hostname and loopback reference are set." partial log)
$(partial set-hostname)
$(contents="Installing kube-apiserver at version $version." partial log)
$(name="kube-apiserver" partial install-k8s)
$(contents="Generating kube-apiserver service file." partial log)
$(path="/etc/systemd/system/kube-apiserver.service" contents="$(
  name="kube-apiserver" \
  after="network.target" \
  exec="$(partial exec-kube-apiserver)" partial systemd-unit)" partial write-file
)
$(contents="Enabling kube-apiserver service." partial log)
$(name="kube-apiserver" partial enable-service)
$(contents="Installing kube-controller-manager at version $version." partial log)
$(name="kube-controller-manager" partial install-k8s)
$(path="/etc/systemd/system/kube-controller-manager.service" contents="$(
  name="kube-controller-manager" \
  after="network.target" \
  requires="" \
  exec="$(partial exec-kube-controller-manager)" partial systemd-unit)" partial write-file
)
$(contents="Enabling kube-controller-manager service." partial log)
$(name="kube-controller-manager" partial enable-service)
$(contents="Installing kube-scheduler at version $version." partial log)
$(name="kube-scheduler" partial install-k8s)
$(path="/etc/systemd/system/kube-scheduler.service" contents="$(
  name="kube-scheduler" \
  after="network.target" \
  requires="" \
  exec="$(partial exec-kube-scheduler)" partial systemd-unit)" partial write-file
)
$(contents="Enabling kube-scheduler service." partial log)
$(name="kube-scheduler" partial enable-service)
$(contents="Installing kubectl at version $version." partial log)
$(name="kubectl" partial install-k8s)

" partial remote-install)
