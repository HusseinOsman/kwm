#------------------------------------------------------------------------------#
echo Sending shared config to $KWM_HOSTNAME.
#------------------------------------------------------------------------------#
$(files="etcd-ca-cert.pem etcd-ca-private-key.pem apiserver-to-etcd-private-key.pem apiserver-to-etcd-cert.pem" \
  exec="$KWM_CONNECT" \
  basePath="$KWM_CONFIG_PATH_REMOTE" \
  sourcePath="$KWM_CONFIG_PATH_LOCAL" template util tar-copy
)
#------------------------------------------------------------------------------#
echo Installing $KWM_HOSTNAME.
#------------------------------------------------------------------------------#
$(exec="$KWM_CONNECT" content="
#------------------------------------------------------------------------------#
echo Generating private key for etcd server to etcd server communication.
#------------------------------------------------------------------------------#
$(basePath="$KWM_CONFIG_PATH_REMOTE" name="etcd-to-etcd" template pki private-key)
#------------------------------------------------------------------------------#
echo Generating etcd-ca signed certificate for etcd server to etcd server communication.
#------------------------------------------------------------------------------#
$(name="etcd-to-etcd" \
  basePath="$KWM_CONFIG_PATH_REMOTE" \
  subj="/CN=etcd-to-etcd/O=etcd" \
  ext="subjectAltName = IP:$KWM_PRIVATE_IP,DNS:$KWM_HOSTNAME" \
  ca="etcd" template pki signed-cert)
#------------------------------------------------------------------------------#
echo Ensuring hostname and loopback reference are set.
#------------------------------------------------------------------------------#
$(name="$KWM_HOSTNAME" template util set-hostname)
#------------------------------------------------------------------------------#
echo Installing etcd at version $KWM_VERSION_ETCD.
#------------------------------------------------------------------------------#
$(version="$KWM_VERSION_ETCD" template installer etcd)
#------------------------------------------------------------------------------#
echo Generating etcd service file.
#------------------------------------------------------------------------------#
$(path="/etc/systemd/system/etcd.service" content="$(
  name="etcd" \
  after="network.target" \
  exec="$(
    configPath="$KWM_CONFIG_PATH_REMOTE" \
    name="$KWM_HOSTNAME" \
    privateIp="$KWM_PRIVATE_IP" \
    initialCluster="$KWM_ETCD_INITIAL_CLUSTER" template service etcd
  )" template service unit)" template util write-file
)
#------------------------------------------------------------------------------#
echo Enabling and restarting service.
#------------------------------------------------------------------------------#
$(name="etcd" template service enable)
" template util remote-script)
