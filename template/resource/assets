#------------------------------------------------------------------------------#
echo Rendering public key infrastructure.
#------------------------------------------------------------------------------#
mkdir -p $KWM_CONFIG_PATH_LOCAL
#------------------------------------------------------------------------------#
echo Generating encryption key.
#------------------------------------------------------------------------------#
$(path="$KWM_CONFIG_PATH_LOCAL/encryption-config.yml" \
  content="$(
    template resource encryption-config
  )" template util write-file
)
#------------------------------------------------------------------------------#
echo Generating cluster certificate authority.
#------------------------------------------------------------------------------#
$(basePath="$KWM_CONFIG_PATH_LOCAL" \
  name="cluster" \
  subj="/CN=$KWM_CLUSTER_NAME" template pki init-ca)
#------------------------------------------------------------------------------#
echo Generating private key for cluster admin to apiserver communication.
#------------------------------------------------------------------------------#
$(basePath="$KWM_CONFIG_PATH_LOCAL" \
  name="cluster-admin-to-apiserver" template pki private-key)
#------------------------------------------------------------------------------#
echo Generating cluster-ca signed certificate for cluster admin to apiserver communication.
#------------------------------------------------------------------------------#
$(basePath="$KWM_CONFIG_PATH_LOCAL" \
  name="cluster-admin-to-apiserver" \
  subj="/CN=root/O=system:masters" \
  ca="cluster" template pki signed-cert)
#------------------------------------------------------------------------------#
echo Generating etcd certificate authority.
#------------------------------------------------------------------------------#
$(basePath="$KWM_CONFIG_PATH_LOCAL" name="etcd" subj="/CN=etcd-ca" template pki init-ca)
#------------------------------------------------------------------------------#
echo Generating private key for apiserver to etcd server communication.
#------------------------------------------------------------------------------#
$(basePath="$KWM_CONFIG_PATH_LOCAL" name="apiserver-to-etcd" template pki private-key)
#------------------------------------------------------------------------------#
echo Generating etcd-ca signed certificate for apiserver to etcd communication.
#------------------------------------------------------------------------------#
$(basePath="$KWM_CONFIG_PATH_LOCAL" \
  name="apiserver-to-etcd" \
  subj="/CN=etcd" \
  ext="subjectAltName = $KWM_ETCD_CLIENT_SANS" \
  ca="etcd" template pki signed-cert)
#------------------------------------------------------------------------------#
echo Generating public/private keypair for service accounts
#------------------------------------------------------------------------------#
$(basePath="$KWM_CONFIG_PATH_LOCAL" name="service-account" template pki private-key)
$(basePath="$KWM_CONFIG_PATH_LOCAL" name="service-account" template pki public-key)
