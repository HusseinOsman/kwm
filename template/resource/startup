#------------------------------------------------------------------------------#
echo Configuring your PKI.
#------------------------------------------------------------------------------#
$SCRIPT_NAME render pki | bash 2>&1 | sed 's/^/[public key infrastructure] /'
#------------------------------------------------------------------------------#
echo Configure your kubectl for cluster admin access.
#------------------------------------------------------------------------------#
$SCRIPT_NAME render cluster-admin | bash 2>&1 | sed 's/^/[getting admin to cluster] /'
#------------------------------------------------------------------------------#
echo Configuring your nodes.
#------------------------------------------------------------------------------#
$SCRIPT_NAME nodes etcd | xargs -n1 $SCRIPT_NAME render etcd-node | bash 2>&1 | sed 's/^/[etcd] /'
$SCRIPT_NAME nodes controlplane | xargs -n1 $SCRIPT_NAME render controlplane-node | bash 2>&1 | sed 's/^/[controlplane] /'
$SCRIPT_NAME nodes worker | xargs -n1 $SCRIPT_NAME render worker-node | bash 2>&1 | sed 's/^/[worker] /'
#------------------------------------------------------------------------------#
echo Installing a container networking plugin.
#------------------------------------------------------------------------------#
mkdir -p manifests/system
$SCRIPT_NAME render cni-manifest > manifests/system/cni.yml
kubectl --context=${KWM_CLUSTER_NAME} apply -f manifests/system/cni.yml | sed 's/^/[container networking] /'
echo Waiting for container networking to start...
#------------------------------------------------------------------------------#
echo HACK bouncing containerd to pick up cni settings from above.
#------------------------------------------------------------------------------#
sleep 30
(($SCRIPT_NAME nodes controlplane && $SCRIPT_NAME nodes worker) | uniq |
  xargs -n1 -I {} bash -c "echo 'sudo systemctl restart containerd' | $SCRIPT_NAME connect {}"
) 2>&1 | sed 's/^/[hack] /'
#------------------------------------------------------------------------------#
echo Installing kube-dns.
#------------------------------------------------------------------------------#
mkdir -p manifests/system
$SCRIPT_NAME render dns-manifest > manifests/system/kube-dns.yml
kubectl --context=${KWM_CLUSTER_NAME} apply -f manifests/system/kube-dns.yml | sed 's/^/[cluster dns] /'
echo Waiting for kube-dns to start...
#------------------------------------------------------------------------------#
echo Confirming the cluster is functional.
#------------------------------------------------------------------------------#
sleep 30
kubectl --context=${KWM_CLUSTER_NAME} get componentstatus
kubectl --context=${KWM_CLUSTER_NAME} get nodes -o wide
kubectl --context=${KWM_CLUSTER_NAME} get pods -o wide --all-namespaces
